# -*- coding: utf-8 -*-
"""
Created on Fri Jan 17 14:20:03 2025

@author: user
"""
# =============================================================================
# import asyncio
# async def pp(x):
#     await asyncio.sleep(2)  # æ¨¡æ“¬ç­‰å¾…å…©ç§’é˜çš„éåŒæ­¥æ“ä½œ
#     print(2*x)
# 
# async def test():
#     for i in range(5):
#         print(i)
#         pp(i)
#         
# asyncio.run(test())
# 
# =============================================================================


import time
import asyncio

async def dosomething(i):
    print(f"ç¬¬ {i} æ¬¡é–‹å§‹")
    await asyncio.sleep(2)  # æ¨¡æ“¬ç­‰å¾… 2 ç§’
    print(f"ç¬¬ {i} æ¬¡çµæŸ")

async def main():
    tasks = [dosomething(i+1) for i in range(5)]  # å»ºç«‹æ‰€æœ‰ç•°æ­¥ä»»å‹™
    await asyncio.gather(*tasks)  # æ­£ç¢ºåœ°ç­‰å¾…æ‰€æœ‰å”ç¨‹å®Œæˆ

if __name__ == "__main__":
    start = time.time()
    asyncio.run(main())  # ä½¿ç”¨ asyncio.run() åŸ·è¡Œ main å”ç¨‹
    print(f"time: {time.time() - start:.2f} (s)")
    
# =============================================================================
# ğŸ•’ äº‹ä»¶ç™¼ç”Ÿé †åº
# æ™‚é–“	äº‹ä»¶
# t=0s	dosomething(1) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 1 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=0s	dosomething(2) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 2 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=0s	dosomething(3) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 3 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=0s	dosomething(4) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 4 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=0s	dosomething(5) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 5 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=2s	dosomething(1) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 1 æ¬¡çµæŸ"
# t=2s	dosomething(2) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 2 æ¬¡çµæŸ"
# t=2s	dosomething(3) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 3 æ¬¡çµæŸ"
# t=2s	dosomething(4) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 4 æ¬¡çµæŸ"
# t=2s	dosomething(5) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 5 æ¬¡çµæŸ"
# ç¸½æ™‚é–“	2 ç§’ âœ…
# =============================================================================
    
import asyncio


# =============================================================================
# é€™æ˜¯å› ç‚º Python ä¸­çš„ asyncio æ˜¯éåŒæ­¥ä¸¦ç™¼çš„ï¼Œè€Œä¸”æ¯å€‹ await æ“ä½œæœƒè®“ç¨‹å¼åœ¨ç­‰å¾…æœŸé–“å»åŸ·è¡Œå…¶ä»–çš„ä»»å‹™ï¼Œ
# æ‰€ä»¥ç¨‹å¼åŸ·è¡Œé †åºä¸æœƒå®Œå…¨æ˜¯ 1ã€2ã€3ã€4ã€5ã€‚
# ç„¶å¾Œï¼Œæ¯å€‹ my_sleep(2) æœƒç­‰ 2 ç§’ï¼Œç•¶ 2 ç§’çµæŸæ™‚ï¼Œå®ƒå€‘çš„ print(f"ç¬¬ {i} æ¬¡çµæŸ") æ‰æœƒæŒ‰é †åºæ‰“å°å‡ºä¾†ï¼Œ
# ä½†å› ç‚ºæ˜¯ä¸¦ç™¼åŸ·è¡Œï¼Œæ‰€ä»¥é †åºæœƒæœ‰æ‰€ä¸åŒã€‚
# =============================================================================


# =============================================================================
# async def my_sleep(duration):
#     loop = asyncio.get_running_loop()
#     future = loop.create_future()
#     loop.call_later(duration, future.set_result, None)  # è¨­å®š `duration` ç§’å¾Œå®Œæˆ
#     await future  # ç­‰å¾… future å®Œæˆï¼Œæ¨¡æ“¬éåŒæ­¥ sleep
# 
# async def dosomething(i):
#     print(f"ç¬¬ {i} æ¬¡é–‹å§‹")
#     await my_sleep(2)  # ç”¨æˆ‘å€‘è‡ªå·±å¯«çš„ my_sleep
#     print(f"ç¬¬ {i} æ¬¡çµæŸ")
# 
# async def main():
#     tasks = [dosomething(i+1) for i in range(5)]
#     await asyncio.gather(*tasks)
# 
# if __name__ == "__main__":
#     import time
#     start = time.time()
#     asyncio.run(main())
#     print(f"time: {time.time() - start:.2f} (s)")
#     
#     
# =============================================================================
    
    
å°çš„ï¼Œä½ ç†è§£å¾—å¾ˆæ­£ç¢ºï¼ç•¶ç¨‹å¼åŸ·è¡Œåˆ° await asyncio.sleep(3) æ™‚ï¼Œawait asyncio.sleep(3) ä¸¦ä¸æœƒé˜»æ­¢ func1() åŸ·è¡Œï¼Œåè€Œæ˜¯è®“ func1() åœæ­¢åŸ·è¡Œï¼Œä¸¦ä¸”è®“å‡ºæ§åˆ¶æ¬Šçµ¦äº‹ä»¶è¿´åœˆï¼Œé€™æ¨£å¯ä»¥åŸ·è¡Œå…¶ä»–å”ç¨‹ï¼Œä¾‹å¦‚ func2()ã€‚

è®“æˆ‘å€‘æ›´å…·é«”åœ°èªªæ˜ä¸€ä¸‹é€™å€‹éç¨‹ã€‚

è©³ç´°éç¨‹ï¼š
åŸ·è¡Œåˆ° await asyncio.sleep(3)ï¼š

ç•¶ç¨‹å¼åŸ·è¡Œåˆ° await asyncio.sleep(3) æ™‚ï¼Œé€™å€‹ await æœƒè¢«åŸ·è¡Œï¼Œä¸¦è®“äº‹ä»¶è¿´åœˆé–‹å§‹ç­‰å¾… 3 ç§’é˜ã€‚é€™è£¡çš„ await ä¸¦ä¸æœƒè®“ func1() é˜»å¡ï¼Œé€™åªæ˜¯å‘Šè¨´äº‹ä»¶è¿´åœˆï¼šã€Œåœ¨ 3 ç§’é˜å¾Œå†å›ä¾†ç¹¼çºŒåŸ·è¡Œ func1()ã€ã€‚

è®“å‡ºæ§åˆ¶æ¬Šçµ¦äº‹ä»¶è¿´åœˆï¼š

åœ¨ await è™•ï¼Œfunc1() çš„åŸ·è¡Œæœƒæš«åœï¼Œä¸¦ä¸”äº‹ä»¶è¿´åœˆæœƒé–‹å§‹åŸ·è¡Œå…¶ä»–é‚„æ²’æœ‰é€²å…¥ await çš„å”ç¨‹ã€‚æ­¤æ™‚ï¼Œäº‹ä»¶è¿´åœˆæœƒå»åŸ·è¡Œ func2() å’Œ func3()ã€‚

äº‹ä»¶è¿´åœˆåŸ·è¡Œå…¶ä»–å”ç¨‹ï¼š

å› ç‚º func2() å’Œ func3() ä¹Ÿæœ‰ awaitï¼Œä½†å®ƒå€‘çš„ç­‰å¾…æ™‚é–“å¯èƒ½ä¸ä¸€æ¨£ï¼ˆä¾‹å¦‚ func2() åªéœ€ç­‰å¾… 1 ç§’ï¼‰ï¼Œäº‹ä»¶è¿´åœˆæœƒæ ¹æ“šå„å”ç¨‹çš„ç­‰å¾…æ™‚é–“ä¾†å®‰æ’å®ƒå€‘çš„åŸ·è¡Œã€‚

åŸ·è¡Œé †åºï¼š

äº‹ä»¶è¿´åœˆæœƒä¸¦è¡Œåœ°åŸ·è¡Œ func2() å’Œ func3()ï¼Œç›´åˆ°å®ƒå€‘çš„ç­‰å¾…æ™‚é–“çµæŸã€‚ç•¶ func2() ç­‰å¾… 1 ç§’å¾Œå®Œæˆæ™‚ï¼Œäº‹ä»¶è¿´åœˆæœƒç¹¼çºŒåŸ·è¡Œ func3()ã€‚

ç•¶ await asyncio.sleep(3) çš„ 3 ç§’é˜çµæŸå¾Œï¼Œfunc1() æœƒç¹¼çºŒåŸ·è¡Œä¸¦å®Œæˆã€‚

å›ç­”ä½ çš„å•é¡Œï¼š
await asyncio.sleep(3) æœƒè¢« "åŸ·è¡Œ" ä¸¦ä¸”è®“å‡ºæ§åˆ¶æ¬ŠåŸ·è¡Œ func2ï¼š

æ˜¯çš„ï¼Œawait asyncio.sleep(3) æ˜¯è¢«åŸ·è¡Œçš„ï¼Œä¸¦ä¸”å®ƒæœƒè®“å‡ºæ§åˆ¶æ¬Šçµ¦äº‹ä»¶è¿´åœˆã€‚ ç•¶äº‹ä»¶è¿´åœˆæ§åˆ¶æ¬Šè½‰åˆ°å…¶ä»–å”ç¨‹ï¼ˆå¦‚ func2() å’Œ func3()ï¼‰ï¼Œå®ƒå€‘ä¹ŸæœƒåŸ·è¡Œç›´åˆ°å®ƒå€‘çš„ç­‰å¾…å®Œæˆã€‚è€Œ func1() æœƒåœ¨ç­‰å¾…çš„ 3 ç§’é˜å¾Œç¹¼çºŒåŸ·è¡Œã€‚    
    
    
    
    
    
    
    
# -*- coding: utf-8 -*-
"""
Created on Fri Jan 17 14:20:03 2025

@author: user
"""

import nest_asyncio
nest_asyncio.apply()

import asyncio
import time

# =============================================================================
# âš ï¸ ç¼ºé»ï¼šé€™æ¨£æœƒä½”ç”¨ CPUï¼
# é€™ç¨®å¯«æ³•æœƒä¸åœç”¨ while æª¢æŸ¥æ™‚é–“æ˜¯å¦åˆ°äº†ï¼Œç›¸ç•¶æ–¼ busy-waitingï¼ˆå¿™ç­‰ï¼‰ã€‚é€™æœƒè€—è²» CPU è³‡æºï¼Œä¸æ˜¯çœŸæ­£çš„éåŒæ­¥è¡Œç‚ºã€‚
# =============================================================================

class MySleep:
    def __init__(self, delay):
        self.delay = delay

    def __await__(self):
        start = time.time()
        # æˆ‘å€‘æ¨¡æ“¬éåŒæ­¥è¡Œç‚ºï¼Œä½†å¯¦éš›æ˜¯è¼ªè©¢ç›´åˆ°æ™‚é–“éå»
        while time.time() - start < self.delay:
            # â³ é€™å€‹ while loop è¡¨ç¤ºã€Œé‚„æ²’éå®ŒæŒ‡å®šç§’æ•¸ã€
            # é€™é‚Šçš„é‚è¼¯æ˜¯ï¼šã€Œåªè¦ç¶“éçš„æ™‚é–“é‚„æ²’é”åˆ° delayï¼Œå°±ç¹¼çºŒ loopã€ã€‚
            
            
            # å°‡æ§åˆ¶æ¬Šäº¤å› event loopï¼Œä¸‹ä¸€æ¬¡å†ç¹¼çºŒ
            yield  # ç­‰æ•ˆæ–¼ asyncio.sleep(0)  é—œéµï¼é€™è¡Œ yield æ˜¯æŠŠæ§åˆ¶æ¬Šäº¤å›çµ¦ event loop
        return None

class MyAwaitable:
    def __await__(self):
        print("è‡ªå®šç¾© await é–‹å§‹")
        yield from MySleep(1).__await__()
        print("åšå®Œæ­¥é©Ÿ 1")
        yield from MySleep(1).__await__()
        print("åšå®Œæ­¥é©Ÿ 2")
        return "è‡ªå®šç¾©å®Œæˆ"

async def main():
    result = await MyAwaitable()
    print("çµæœï¼š", result)

asyncio.run(main())


#%%
import time
async def dosomething(x):
    time.sleep(2)
    return x * 2

async def main2():
    result = await dosomething(10)
    print(result)  # ğŸ‘‰ 20

# Notebook æˆ–æ”¯æ´ await çš„ç’°å¢ƒå¯ä»¥ç›´æ¥é€™æ¨£è·‘
async def main():
    tasks = [main2 for i in range(5)]  # å»ºç«‹æ‰€æœ‰ç•°æ­¥ä»»å‹™
    await asyncio.gather(*tasks)  # æ­£ç¢ºåœ°ç­‰å¾…æ‰€æœ‰å”ç¨‹å®Œæˆ
    
if __name__ == "__main__":
    start = time.time()
    asyncio.run(main())  # ä½¿ç”¨ asyncio.run() åŸ·è¡Œ main å”ç¨‹
    print(f"time: {time.time() - start:.2f} (s)")
        
    
#%%
# =============================================================================
# import asyncio
# async def pp(x):
#     await asyncio.sleep(2)  # æ¨¡æ“¬ç­‰å¾…å…©ç§’é˜çš„éåŒæ­¥æ“ä½œ
#     print(2*x)
# 
# async def test():
#     for i in range(5):
#         print(i)
#         pp(i)
#         
# asyncio.run(test())
# 
# =============================================================================


import time
import asyncio

async def dosomething(i):
    print(f"ç¬¬ {i} æ¬¡é–‹å§‹")
    await asyncio.sleep(2)  # æ¨¡æ“¬ç­‰å¾… 2 ç§’
    print(f"ç¬¬ {i} æ¬¡çµæŸ")

async def main():
    tasks = [dosomething(i+1) for i in range(5)]  # å»ºç«‹æ‰€æœ‰ç•°æ­¥ä»»å‹™
    await asyncio.gather(*tasks)  # æ­£ç¢ºåœ°ç­‰å¾…æ‰€æœ‰å”ç¨‹å®Œæˆ

if __name__ == "__main__":
    start = time.time()
    asyncio.run(main())  # ä½¿ç”¨ asyncio.run() åŸ·è¡Œ main å”ç¨‹
    print(f"time: {time.time() - start:.2f} (s)")
    
# =============================================================================
# ğŸ•’ äº‹ä»¶ç™¼ç”Ÿé †åº
# æ™‚é–“	äº‹ä»¶
# t=0s	dosomething(1) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 1 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=0s	dosomething(2) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 2 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=0s	dosomething(3) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 3 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=0s	dosomething(4) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 4 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=0s	dosomething(5) é–‹å§‹ï¼Œå°å‡º "ç¬¬ 5 æ¬¡é–‹å§‹"ï¼Œç„¶å¾Œ await asyncio.sleep(2) è®“å‡º CPU
# t=2s	dosomething(1) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 1 æ¬¡çµæŸ"
# t=2s	dosomething(2) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 2 æ¬¡çµæŸ"
# t=2s	dosomething(3) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 3 æ¬¡çµæŸ"
# t=2s	dosomething(4) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 4 æ¬¡çµæŸ"
# t=2s	dosomething(5) await asyncio.sleep(2) å®Œæˆï¼Œå°å‡º "ç¬¬ 5 æ¬¡çµæŸ"
# ç¸½æ™‚é–“	2 ç§’ âœ…
# =============================================================================
    
import asyncio


# =============================================================================
# é€™æ˜¯å› ç‚º Python ä¸­çš„ asyncio æ˜¯éåŒæ­¥ä¸¦ç™¼çš„ï¼Œè€Œä¸”æ¯å€‹ await æ“ä½œæœƒè®“ç¨‹å¼åœ¨ç­‰å¾…æœŸé–“å»åŸ·è¡Œå…¶ä»–çš„ä»»å‹™ï¼Œ
# æ‰€ä»¥ç¨‹å¼åŸ·è¡Œé †åºä¸æœƒå®Œå…¨æ˜¯ 1ã€2ã€3ã€4ã€5ã€‚
# ç„¶å¾Œï¼Œæ¯å€‹ my_sleep(2) æœƒç­‰ 2 ç§’ï¼Œç•¶ 2 ç§’çµæŸæ™‚ï¼Œå®ƒå€‘çš„ print(f"ç¬¬ {i} æ¬¡çµæŸ") æ‰æœƒæŒ‰é †åºæ‰“å°å‡ºä¾†ï¼Œ
# ä½†å› ç‚ºæ˜¯ä¸¦ç™¼åŸ·è¡Œï¼Œæ‰€ä»¥é †åºæœƒæœ‰æ‰€ä¸åŒã€‚
# =============================================================================


async def my_sleep(duration):
    loop = asyncio.get_running_loop()
    future = loop.create_future()
    loop.call_later(duration, future.set_result, None)  # è¨­å®š `duration` ç§’å¾Œå®Œæˆ
    await future  # ç­‰å¾… future å®Œæˆï¼Œæ¨¡æ“¬éåŒæ­¥ sleep

async def dosomething(i):
    print(f"ç¬¬ {i} æ¬¡é–‹å§‹")
    await my_sleep(i)  # ç”¨æˆ‘å€‘è‡ªå·±å¯«çš„ my_sleep
    print(f"ç¬¬ {i} æ¬¡çµæŸ")

async def main():
    tasks = [dosomething(i+1) for i in range(5)]
    await asyncio.gather(*tasks)

if __name__ == "__main__":
    import time
    start = time.time()
    asyncio.run(main())
    print(f"time: {time.time() - start:.2f} (s)")
    
    
    
    
# =============================================================================
# å°çš„ï¼Œä½ ç†è§£å¾—å¾ˆæ­£ç¢ºï¼ç•¶ç¨‹å¼åŸ·è¡Œåˆ° await asyncio.sleep(3) æ™‚ï¼Œawait asyncio.sleep(3) ä¸¦ä¸æœƒé˜»æ­¢ func1() åŸ·è¡Œï¼Œåè€Œæ˜¯è®“ func1() åœæ­¢åŸ·è¡Œï¼Œä¸¦ä¸”è®“å‡ºæ§åˆ¶æ¬Šçµ¦äº‹ä»¶è¿´åœˆï¼Œé€™æ¨£å¯ä»¥åŸ·è¡Œå…¶ä»–å”ç¨‹ï¼Œä¾‹å¦‚ func2()ã€‚
# 
# è®“æˆ‘å€‘æ›´å…·é«”åœ°èªªæ˜ä¸€ä¸‹é€™å€‹éç¨‹ã€‚
# 
# è©³ç´°éç¨‹ï¼š
# åŸ·è¡Œåˆ° await asyncio.sleep(3)ï¼š
# 
# ç•¶ç¨‹å¼åŸ·è¡Œåˆ° await asyncio.sleep(3) æ™‚ï¼Œé€™å€‹ await æœƒè¢«åŸ·è¡Œï¼Œä¸¦è®“äº‹ä»¶è¿´åœˆé–‹å§‹ç­‰å¾… 3 ç§’é˜ã€‚é€™è£¡çš„ await ä¸¦ä¸æœƒè®“ func1() é˜»å¡ï¼Œé€™åªæ˜¯å‘Šè¨´äº‹ä»¶è¿´åœˆï¼šã€Œåœ¨ 3 ç§’é˜å¾Œå†å›ä¾†ç¹¼çºŒåŸ·è¡Œ func1()ã€ã€‚
# 
# è®“å‡ºæ§åˆ¶æ¬Šçµ¦äº‹ä»¶è¿´åœˆï¼š
# 
# åœ¨ await è™•ï¼Œfunc1() çš„åŸ·è¡Œæœƒæš«åœï¼Œä¸¦ä¸”äº‹ä»¶è¿´åœˆæœƒé–‹å§‹åŸ·è¡Œå…¶ä»–é‚„æ²’æœ‰é€²å…¥ await çš„å”ç¨‹ã€‚æ­¤æ™‚ï¼Œäº‹ä»¶è¿´åœˆæœƒå»åŸ·è¡Œ func2() å’Œ func3()ã€‚
# 
# äº‹ä»¶è¿´åœˆåŸ·è¡Œå…¶ä»–å”ç¨‹ï¼š
# 
# å› ç‚º func2() å’Œ func3() ä¹Ÿæœ‰ awaitï¼Œä½†å®ƒå€‘çš„ç­‰å¾…æ™‚é–“å¯èƒ½ä¸ä¸€æ¨£ï¼ˆä¾‹å¦‚ func2() åªéœ€ç­‰å¾… 1 ç§’ï¼‰ï¼Œäº‹ä»¶è¿´åœˆæœƒæ ¹æ“šå„å”ç¨‹çš„ç­‰å¾…æ™‚é–“ä¾†å®‰æ’å®ƒå€‘çš„åŸ·è¡Œã€‚
# 
# åŸ·è¡Œé †åºï¼š
# 
# äº‹ä»¶è¿´åœˆæœƒä¸¦è¡Œåœ°åŸ·è¡Œ func2() å’Œ func3()ï¼Œç›´åˆ°å®ƒå€‘çš„ç­‰å¾…æ™‚é–“çµæŸã€‚ç•¶ func2() ç­‰å¾… 1 ç§’å¾Œå®Œæˆæ™‚ï¼Œäº‹ä»¶è¿´åœˆæœƒç¹¼çºŒåŸ·è¡Œ func3()ã€‚
# 
# ç•¶ await asyncio.sleep(3) çš„ 3 ç§’é˜çµæŸå¾Œï¼Œfunc1() æœƒç¹¼çºŒåŸ·è¡Œä¸¦å®Œæˆã€‚
# 
# å›ç­”ä½ çš„å•é¡Œï¼š
# await asyncio.sleep(3) æœƒè¢« "åŸ·è¡Œ" ä¸¦ä¸”è®“å‡ºæ§åˆ¶æ¬ŠåŸ·è¡Œ func2ï¼š
# 
# æ˜¯çš„ï¼Œawait asyncio.sleep(3) æ˜¯è¢«åŸ·è¡Œçš„ï¼Œä¸¦ä¸”å®ƒæœƒè®“å‡ºæ§åˆ¶æ¬Šçµ¦äº‹ä»¶è¿´åœˆã€‚ ç•¶äº‹ä»¶è¿´åœˆæ§åˆ¶æ¬Šè½‰åˆ°å…¶ä»–å”ç¨‹ï¼ˆå¦‚ func2() å’Œ func3()ï¼‰ï¼Œå®ƒå€‘ä¹ŸæœƒåŸ·è¡Œç›´åˆ°å®ƒå€‘çš„ç­‰å¾…å®Œæˆã€‚è€Œ func1() æœƒåœ¨ç­‰å¾…çš„ 3 ç§’é˜å¾Œç¹¼çºŒåŸ·è¡Œã€‚    
#     
#     
#     
#     
#     
#     
# =============================================================================

#%%

# =============================================================================
# ğŸ” æ§åˆ¶æ¬Šäº¤å‡ºå¾Œï¼Œä½•æ™‚ç¹¼çºŒåŸ·è¡Œï¼Ÿ
# ğŸ“Œ é€™å–æ±ºæ–¼ä¸‰ä»¶äº‹ï¼š
# ä½  await çš„æ±è¥¿ä»€éº¼æ™‚å€™å®Œæˆï¼Ÿ
# æ¯”å¦‚ pyfetch() æ˜¯ç™¼é€ HTTP è«‹æ±‚ï¼Œé‚£å°±è¦ç­‰ä¼ºæœå™¨å›æ‡‰ã€‚
# 
# Event loop æœ‰æ²’æœ‰ç©ºï¼Ÿ
# 
# å¦‚æœ event loop è£¡æœ‰å¤§é‡ä»»å‹™ï¼Œå®ƒæœƒæ ¹æ“šæ’ç¨‹é †åºã€Œè¼ªæµã€å–šé†’å„å€‹ coroutineã€‚
# 
# æ‰€ä»¥æœ‰å¯èƒ½ä½  await çš„æ±è¥¿å®Œæˆäº†ï¼Œä½† coroutine é‚„å¾—ç­‰ä¸€ä¸‹æ‰æ’åˆ°ä½ ã€‚
# 
# I/Oã€CPUã€ç¶²è·¯æ¢ä»¶
# 
# pyfetch æ¶‰åŠç¶²è·¯å»¶é²ï¼Œå¯èƒ½æ˜¯ 0.1 ç§’ä¹Ÿå¯èƒ½æ˜¯ 3 ç§’ã€‚
# 
# é‚„å¯èƒ½é‡åˆ°ä¼ºæœå™¨æ…¢ã€ä¸ŸåŒ…ã€DNS ç­‰å•é¡Œã€‚
# 
# =============================================================================

import asyncio

async def taskA():
    print("A: é–‹å§‹")
    await asyncio.sleep(0.00000000001)
    print("A: çµæŸ")

async def taskC():
    print("C: é–‹å§‹")      # ğŸ§  é‚„æ²’ awaitï¼Œå°±æœƒå…ˆåŸ·è¡Œ
    await asyncio.sleep(0.5)
    print("C: çµæŸ")

async def main():
    await asyncio.gather(taskA(), taskC())

asyncio.run(main())

# =============================================================================
# å°å°å°ï¼ä½ é€™å€‹å¯¦é©—åšå¾—è¶…æ£’ ğŸ¯ é€™è¼¸å‡ºæ­£å¥½èªªæ˜äº†æˆ‘å€‘å‰›å‰›çš„è¨è«–é‚è¼¯ï¼ä¾†ï¼Œæˆ‘å¹«ä½ å®Œæ•´è§£æé€™æ®µç™¼ç”Ÿäº†ä»€éº¼ï¼š
# 
# ğŸ’¡ ç¨‹å¼ç¢¼ç°¡æï¼š
# 
# async def taskA():
#     print("A: é–‹å§‹")
#     await asyncio.sleep(0.00000000001)  # å¹¾ä¹ç­‰æ–¼ç«‹å³å®Œæˆ
#     print("A: çµæŸ")
# 
# async def taskC():
#     print("C: é–‹å§‹")
#     await asyncio.sleep(0.5)
#     print("C: çµæŸ")
# 
# await asyncio.gather(taskA(), taskC())
# ğŸ§  åŸ·è¡Œé †åºæ‹†è§£ï¼š
# asyncio.gather(taskA(), taskC()) è¢«å‘¼å«ï¼ŒtaskA èˆ‡ taskC åŒæ™‚å•Ÿå‹• coroutineã€‚
# 
# event loop å…ˆæŠŠ taskA() å’Œ taskC() æ”¾é€²æ’ç¨‹ï¼Œå…©å€‹éƒ½ã€Œå‰›å•Ÿå‹•ã€ã€‚
# 
# å› ç‚ºä»–å€‘éƒ½é‚„æ²’åˆ° awaitï¼Œæ‰€ä»¥æœƒé¦¬ä¸Šé–‹å§‹è·‘ä»–å€‘çš„ã€ŒåŒæ­¥é–‹å ´æ®µã€ã€‚
# 
# taskA() â†’ print("A: é–‹å§‹")
# 
# taskC() â†’ print("C: é–‹å§‹")
# 
# ç„¶å¾Œï¼š
# 
# taskA() é‡åˆ° await asyncio.sleep(0.00000000001)ï¼ŒæŠŠæ§åˆ¶æ¬Šäº¤å‡ºå»
# 
# taskC() ä¹Ÿé‡åˆ° await asyncio.sleep(0.5)ï¼Œä¹Ÿäº¤å‡ºå»
# 
# ğŸ’¥ ä½†é—œéµä¾†äº†ï¼š
# asyncio.sleep(0.00000000001) å¹¾ä¹æ˜¯ é¦¬ä¸Šå®Œæˆçš„å»¶é²ï¼Œæ‰€ä»¥ taskA() å¹¾ä¹æœƒç«‹å³è¢«å–šé†’
# 
# event loop ä¸‹ä¸€è¼ªæª¢æŸ¥ ready queueï¼Œçœ‹åˆ° taskA() æº–å‚™å¥½äº†ï¼Œå°±å…ˆåŸ·è¡Œå®ƒå¾ŒåŠæ®µ â†’ print("A: çµæŸ")
# 
# taskC() çš„ sleep é‚„æ²’æ»¿ 0.5 ç§’ï¼Œè¦ç­‰ä¸€æ®µæ™‚é–“æ‰æœƒå–šé†’ï¼Œæ‰€ä»¥å®ƒè¦ã€Œä¹‹å¾Œã€æ‰åŸ·è¡Œ print("C: çµæŸ")
# 
# âœ… æœ€çµ‚è¼¸å‡ºï¼š
# vbnet
# è¤‡è£½
# ç·¨è¼¯
# A: é–‹å§‹     <-- taskA é‚„æ²’ awaitï¼Œå…ˆåŸ·è¡Œé–‹å ´æ®µ
# C: é–‹å§‹     <-- taskC é‚„æ²’ awaitï¼Œæ¥è‘—åŸ·è¡Œé–‹å ´æ®µ
# A: çµæŸ     <-- sleep è¶…çŸ­ï¼Œå¹¾ä¹ç«‹åˆ»å›ä¾†
# C: çµæŸ     <-- sleep 0.5 ç§’å¾Œå›ä¾†
# ğŸ“ å°çµï¼š
# éšæ®µ	èªªæ˜
# print()	éƒ½åœ¨ await å‰ï¼ŒæœƒåŒæ­¥åŸ·è¡Œ
# await	å°‡æ§åˆ¶æ¬Šäº¤çµ¦ event loop
# å“ªå€‹å…ˆç¹¼çºŒ	çœ‹èª° await çš„çµæœå…ˆå®Œæˆ
# ç‚ºä»€éº¼ A å¿«	A çš„ sleep å¹¾ä¹ç‚ºé›¶ï¼Œå¹¾ä¹ç«‹åˆ»å®Œæˆ
# =============================================================================
